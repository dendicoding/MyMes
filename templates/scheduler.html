{% extends "base.html" %}

{% block title %}
    Task Scheduler
{% endblock %}

{% block head %}
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.0.0/index.min.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Stile generale della pagina */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* Stile del contenitore del calendario */
        /* Stile del contenitore del calendario */
        #calendar {
            width: calc(100% - 20px); /* Riduce la larghezza del calendario per lasciare spazio ai bordi */
            max-width: 1400px; /* Imposta una larghezza massima per evitare che il calendario diventi troppo largo su schermi grandi */
            min-height: 700px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
            position: relative;
            overflow: auto; /* Nasconde il contenuto che esce dai bordi del calendario */
        }


        /* Stile della lista dei task */
        #task-list {
            width: 220px;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }

        /* Stile degli elementi della lista dei task */
        .task-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            margin-bottom: 12px;
            cursor: grab;
            background-color: #fafafa;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task-item:hover {
            background-color: #e3e3e3;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Allineamento orizzontale tra lista dei task e calendario */
        .row {
            display: flex;
            width: 100%;
            gap: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .col-md-10 {
            flex: 1;
        }

        /* Stile del pulsante di eliminazione all'interno del riquadro del task */
        .fc-event-delete-button {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 5px 8px;
            font-size: 12px;
            z-index: 1000;
            transition: background 0.2s;
        }

        .fc-event-delete-button:hover {
            background: #e60000;
        }

        /* Stile per il pulsante di cambio vista */
        #switch-view-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 18px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
            transition: background 0.2s;
        }

        #switch-view-button:hover {
            background-color: #0056b3;
        }

        /* Nascondi il pulsante di cambio vista nella vista mensile */
        .fc-dayGridMonth .fc-dayGridMonth-view #switch-view-button {
            display: none;
        }

        /* Stile per il titolo del calendario */
        .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-2">
                <div id="task-list" class="card">
                    <h5 class="card-title">Tasks</h5>
                    <!-- Task list will be populated here -->
                </div>
            </div>
            <div class="col-md-10">
                <button id="switch-view-button">Switch to Month View</button>
                <div id="calendar" class="card"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.0.0/index.global.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const taskListEl = document.getElementById('task-list');
            const switchViewButton = document.getElementById('switch-view-button');

            // Colori predefiniti per i task
            const colors = ['#FF6347', '#4682B4', '#32CD32', '#FFD700', '#FF69B4', '#8A2BE2', '#FF4500', '#00CED1', '#7FFF00'];

            // Funzione per ottenere un colore casuale dall'array
            function getRandomColor() {
                return colors[Math.floor(Math.random() * colors.length)];
            }

            // Initialize FullCalendar
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                editable: true,
                droppable: true,
                height: 500,
                slotDuration: '00:15:00',
                slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false }, // 24-hour format
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false }, // 24-hour format
                eventResizableFromStart: true,
                timeZone: 'local', // Usa il fuso orario locale del browser
                allDaySlot: false, // Disabilita lo slot "All Day"
                events: '/scheduler/events',
                eventDrop: function(info) {
                    updateTaskSchedule(info.event.id, info.event.start, info.event.end);
                },
                eventResize: function(info) {
                    updateTaskSchedule(info.event.id, info.event.start, info.event.end);
                },
                eventDidMount: function(info) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('fc-event-delete-button');
                    deleteButton.addEventListener('click', function() {
                        if (confirm('Are you sure you want to delete this task?')) {
                            deleteEvent(info.event.id);
                        }
                    });

                    // Posiziona il pulsante delete all'interno del riquadro dell'evento
                    info.el.style.position = 'relative';
                    info.el.appendChild(deleteButton);
                },
                eventReceive: function(info) {
                    const taskId = info.event.id;
                    const start = info.event.start;
                    const end = info.event.end;

                    // Aggiorna la pianificazione del task
                    updateTaskSchedule(taskId, start, end);
                },
                dateClick: function(info) {
                    // Cambia la vista a timeGridDay quando si clicca su un giorno
                    calendar.changeView('timeGridDay', info.dateStr);
                },
                viewDidMount: function(view) {
                    if (view.view.type === 'timeGridDay') {
                        switchViewButton.style.display = 'block'; // Mostra il pulsante in vista giornaliera
                    } else {
                        switchViewButton.style.display = 'none'; // Nascondi il pulsante in altre viste
                    }
                }
            });

            calendar.render();

            fetch('/tasks_json')
                .then(response => response.json())
                .then(tasks => {
                    tasks.forEach(task => {
                        const taskColor = getRandomColor(); // Genera un colore casuale per ogni task

                        // Crea un elemento nella lista dei task
                        const taskEl = document.createElement('div');
                        taskEl.classList.add('task-item');
                        taskEl.textContent = task.title;
                        taskEl.setAttribute('data-task-id', task.id);
                        taskEl.setAttribute('draggable', true);
                        taskEl.style.backgroundColor = taskColor; // Applica il colore al task

                        taskEl.addEventListener('dragstart', function(event) {
                            event.dataTransfer.setData('text/plain', task.id);
                        });

                        taskListEl.appendChild(taskEl);

                        // Crea un evento nel calendario con una data passata di default
                        calendar.addEvent({
                            id: task.id,
                            title: task.title,
                            start: '1900-01-01T00:00:00', // Data molto lontana nel passato
                            end: '1900-01-01T01:00:00', // Durata di default
                            backgroundColor: taskColor, // Applica il colore all'evento nel calendario
                            borderColor: taskColor
                        });
                    });
                })
                .catch(error => {
                    console.error('Failed to load tasks:', error);
                });

            calendarEl.addEventListener('dragover', function(event) {
                event.preventDefault();
            });

            calendarEl.addEventListener('drop', function(event) {
                event.preventDefault();
                event.stopPropagation();

                const taskId = event.dataTransfer.getData('text/plain');
                const taskElement = document.querySelector(`.task-item[data-task-id="${taskId}"]`);

                if (!taskElement) return;

                const taskTitle = taskElement.textContent;
                const taskColor = taskElement.style.backgroundColor; // Recupera il colore del task
                const start = calendar.getDate();
                const end = new Date(start);
                end.setHours(start.getHours() + 1); // Assuming a default duration of 1 hour

                calendar.addEvent({
                    id: taskId,
                    title: taskTitle,
                    start: start,
                    end: end,
                    backgroundColor: taskColor, // Applica il colore all'evento nel calendario
                    borderColor: taskColor
                });

                updateTaskSchedule(taskId, start, end);
            });

            switchViewButton.addEventListener('click', function() {
                calendar.changeView('dayGridMonth'); // Cambia alla vista mensile
            });

            function updateTaskSchedule(taskId, start, end) {
                const startUTC = new Date(start.getTime() - start.getTimezoneOffset() * 60000).toISOString();
                const endUTC = new Date(end.getTime() - end.getTimezoneOffset() * 60000).toISOString();

                fetch('/update_task_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        prog_start_time: startUTC,
                        prog_end_time: endUTC
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Task schedule updated successfully!');
                    } else {
                        alert('Failed to update task schedule.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }

            function deleteEvent(taskId) {
                fetch('/delete_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        calendar.getEventById(taskId).remove();
                        alert('Task deleted successfully!');
                    } else {
                        alert('Failed to delete task.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });

    </script>
{% endblock %}
